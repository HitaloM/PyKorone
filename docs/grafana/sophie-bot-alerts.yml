groups:
  - name: sophie_bot.rules
    rules:
      - alert: MPSLow
        expr: sum without(instance) (rate(sophie_messages_total[1m])) < 1
        for: 1m
        labels:
          severity: warning
          service: sophie-bot
        annotations:
          summary: "Low message rate"
          description: "Messages per second across fleet < 1 for > 1 minute. Current rate: {{ $value | humanize }}msg/s"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#mpslow"

      - alert: HandlerTooSlow
        expr: histogram_quantile(0.99, sum by (le) (rate(sophie_handler_duration_seconds_bucket[5m]))) > 30
        for: 1m
        labels:
          severity: critical
          service: sophie-bot
        annotations:
          summary: "Handler latency too high (p99 > 30s)"
          description: "Handler p99 latency exceeded 30s for 1 minute. Current p99: {{ $value | humanizeDuration }}"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#handlertoslow"

      - alert: EventLoopLagHigh
        expr: max(sophie_event_loop_lag_seconds) > 5.0
        for: 30s
        labels:
          severity: warning
          service: sophie-bot
        annotations:
          summary: "High event loop lag detected"
          description: "Event loop lag is {{ $value | humanizeDuration }}, indicating potential performance issues"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#eventlooplag"

      - alert: HighHandlerErrorRate
        expr: sum(rate(sophie_handler_errors_total[5m])) > 0.1
        for: 2m
        labels:
          severity: warning
          service: sophie-bot
        annotations:
          summary: "High handler error rate"
          description: "Handler error rate is {{ $value | humanize }} errors/s over the last 5 minutes"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#handlererrors"

      - alert: ExternalServiceDown
        expr: sum by(service) (rate(sophie_external_errors_total[5m])) > 0.5
        for: 1m
        labels:
          severity: critical
          service: sophie-bot
        annotations:
          summary: "External service {{ $labels.service }} experiencing high error rate"
          description: "External service {{ $labels.service }} error rate is {{ $value | humanize }} errors/s"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#externalservices"

      - alert: SophieBotInstanceDown
        expr: up{job="sophie-bot"} == 0
        for: 30s
        labels:
          severity: critical
          service: sophie-bot
        annotations:
          summary: "Sophie Bot instance down"
          description: "Sophie Bot instance {{ $labels.instance }} has been down for more than 30 seconds"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#instancedown"

      - alert: HighMemoryUsage
        expr: process_resident_memory_bytes{job="sophie-bot"} > 2147483648  # 2GB
        for: 5m
        labels:
          severity: warning
          service: sophie-bot
        annotations:
          summary: "High memory usage on Sophie Bot instance"
          description: "Instance {{ $labels.instance }} is using {{ $value | humanizeBytes }} of memory"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#memoryusage"

  # Recording rules for better performance and reusability
  - name: sophie_bot.recording_rules
    rules:
      - record: sophie:messages_per_second
        expr: sum without(instance) (rate(sophie_messages_total[1m]))

      - record: sophie:handler_p99_latency
        expr: histogram_quantile(0.99, sum by (le) (rate(sophie_handler_duration_seconds_bucket[5m])))

      - record: sophie:handler_p95_latency
        expr: histogram_quantile(0.95, sum by (le) (rate(sophie_handler_duration_seconds_bucket[5m])))

      - record: sophie:handler_p50_latency
        expr: histogram_quantile(0.50, sum by (le) (rate(sophie_handler_duration_seconds_bucket[5m])))

      - record: sophie:external_service_p95_latency
        expr: histogram_quantile(0.95, sum by (service, le) (rate(sophie_external_request_duration_seconds_bucket[5m])))

      - record: sophie:handler_error_rate
        expr: sum by(handler) (rate(sophie_handler_errors_total[5m]))

      - record: sophie:external_service_error_rate
        expr: sum by(service) (rate(sophie_external_errors_total[5m]))

      - record: sophie:update_rate_by_type
        expr: sum by(update_type) (rate(sophie_updates_total[5m]))

      - record: sophie:message_rate_by_kind
        expr: sum by(message_kind) (rate(sophie_messages_total[5m]))
      
      # AI-specific recording rules
      - record: sophie:ai_request_rate
        expr: sum without(instance) (rate(sophie_ai_requests_total[5m]))

      - record: sophie:ai_error_rate
        expr: sum without(instance) (rate(sophie_ai_errors_total[5m]))

      - record: sophie:ai_request_p95_latency
        expr: histogram_quantile(0.95, sum by (provider, le) (rate(sophie_ai_request_duration_seconds_bucket[5m])))

      - record: sophie:ai_tool_error_rate
        expr: sum by(tool_name) (rate(sophie_ai_tool_calls_total{status="error"}[5m]))

  # AI-specific alerting rules
  - name: sophie_bot.ai_alerts
    rules:
      - alert: AIHighErrorRate
        expr: sum(rate(sophie_ai_errors_total[5m])) > 0.05
        for: 2m
        labels:
          severity: warning
          service: sophie-bot
          component: ai
        annotations:
          summary: "High AI error rate detected"
          description: "AI error rate is {{ $value | humanize }} errors/s over the last 5 minutes"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#aierrors"

      - alert: AIProviderDown
        expr: sum by(provider) (rate(sophie_ai_errors_total[5m])) > 0.1
        for: 1m
        labels:
          severity: critical
          service: sophie-bot
          component: ai
        annotations:
          summary: "AI provider {{ $labels.provider }} experiencing high error rate"
          description: "AI provider {{ $labels.provider }} error rate is {{ $value | humanize }} errors/s"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#aiprovider"

      - alert: AISlowResponse
        expr: histogram_quantile(0.95, sum by (provider, le) (rate(sophie_ai_request_duration_seconds_bucket[5m]))) > 30
        for: 2m
        labels:
          severity: warning
          service: sophie-bot
          component: ai
        annotations:
          summary: "AI provider {{ $labels.provider }} is responding slowly"
          description: "AI provider {{ $labels.provider }} p95 latency is {{ $value | humanizeDuration }}"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#ailatency"

      - alert: AIToolFailures
        expr: sum by(tool_name) (rate(sophie_ai_tool_calls_total{status="error"}[5m])) > 0.02
        for: 3m
        labels:
          severity: warning
          service: sophie-bot
          component: ai
        annotations:
          summary: "AI tool {{ $labels.tool_name }} experiencing failures"
          description: "AI tool {{ $labels.tool_name }} error rate is {{ $value | humanize }} errors/s"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#aitools"

      - alert: AIConversationsStuck
        expr: sum(sophie_ai_active_conversations) > 50
        for: 10m
        labels:
          severity: warning
          service: sophie-bot
          component: ai
        annotations:
          summary: "High number of active AI conversations"
          description: "{{ $value }} AI conversations have been active for over 10 minutes, possible memory leak or stuck conversations"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#aiconversations"

      - alert: AITokenUsageHigh
        expr: sum(rate(sophie_ai_tokens_total[1h])) > 100000
        for: 5m
        labels:
          severity: warning
          service: sophie-bot
          component: ai
        annotations:
          summary: "High AI token usage detected"
          description: "AI token consumption is {{ $value | humanize }} tokens/hour, check for unusual usage patterns"
          runbook_url: "https://sophie-wiki.orangefox.tech/docs/monitoring/alerts#aitokens"