=================================================================================================== test session starts ===================================================================================================
platform linux -- Python 3.13.9, pytest-9.0.2, pluggy-1.6.0
rootdir: /home/yacha/Projects/Otty/sophie
configfile: pyproject.toml
plugins: devtools-0.12.2, anyio-4.12.0, asyncio-1.3.0, allure-pytest-2.15.3
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... 2026-01-08 10:30:50 [info     ] Using BotAPI server: TelegramAPIServer(base='https://api.telegram.org/bot{token}/{method}', file='https://api.telegram.org/file/bot{token}/{path}', is_local=False, wrap_local_file=<aiogram.client.telegram.BareFilesPathWrapper object at 0x7f3aa6204590>) [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] {"message": "Starting topology monitoring", "topologyId": {"$oid": "695f875a29d04f4a8e972be6"}} [pymongo.topology]
2026-01-08 10:30:50 [debug    ] {"message": "Topology description changed", "topologyId": {"$oid": "695f875a29d04f4a8e972be6"}, "previousDescription": "<TopologyDescription id: 695f875a29d04f4a8e972be6, topology_type: Unknown, servers: []>", "newDescription": "<TopologyDescription id: 695f875a29d04f4a8e972be6, topology_type: Unknown, servers: [<ServerDescription ('127.0.0.1', 27017) server_type: Unknown, rtt: None>]>"} [pymongo.topology]
2026-01-08 10:30:50 [debug    ] {"message": "Starting server monitoring", "topologyId": {"$oid": "695f875a29d04f4a8e972be6"}, "serverHost": "127.0.0.1", "serverPort": 27017} [pymongo.topology]
2026-01-08 10:30:50 [debug    ] >>> None: [b'CLIENT', b'SETINFO', b'LIB-NAME', b'redis-py'] [fakeredis]
2026-01-08 10:30:50 [debug    ] >>> None: [b'CLIENT', b'SETINFO', b'LIB-VER', b'7.1.0'] [fakeredis]
2026-01-08 10:30:50 [debug    ] >>> None: [b'CLIENT', b'SETINFO', b'LIB-NAME', b'redis-py'] [fakeredis]
2026-01-08 10:30:50 [debug    ] >>> None: [b'CLIENT', b'SETINFO', b'LIB-VER', b'7.1.0'] [fakeredis]
2026-01-08 10:30:50 [debug    ] Loading legacy localizations... [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file ar_EG.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file ar_SA.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file cs_CZ.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file es_ES.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file fr_FR.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file pl_PL.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file pt_BR.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file ru_RU.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file tr_TR.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file uk_UA.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file zh_CN.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file de_DE.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file en_GB.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file en.yaml  [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading language file fi_FI.yaml [sophie_bot.services.bot]
2026-01-08 10:30:50 [info     ] Legacy languages loaded: ['ar_EG', 'ar_SA', 'cs_CZ', 'es_ES', 'fr_FR', 'pl_PL', 'pt_BR', 'ru_RU', 'tr_TR', 'uk_UA', 'zh_CN', 'de_DE', 'en_GB', 'en', 'fi_FI'] [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] Loading locales additional data... [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale ar_EG! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale ar_SA! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale cs_CZ! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale de_DE! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale en_US! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale es_ES! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale fr_FR! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale pl_PL! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale pt_BR! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale ru_RU! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale tr_TR! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale uk_UA! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale zh_CN! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale en_GB! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Can't parse stats for locale fi_FI! [sophie_bot.services.bot]
2026-01-08 10:30:50 [debug    ] ! Legacy @register: Duplication of /lang command [sophie_bot.services.bot]
2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
2026-01-08 10:30:51 [debug    ] {"message": "Starting topology monitoring", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}} [pymongo.topology]
2026-01-08 10:30:51 [debug    ] {"message": "Topology description changed", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "previousDescription": "<TopologyDescription id: 695f875b29d04f4a8e972be7, topology_type: Unknown, servers: []>", "newDescription": "<TopologyDescription id: 695f875b29d04f4a8e972be7, topology_type: Unknown, servers: [<ServerDescription ('127.0.0.1', 27017) server_type: Unknown, rtt: None>]>"} [pymongo.topology]
2026-01-08 10:30:51 [debug    ] {"message": "Starting server monitoring", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "serverHost": "127.0.0.1", "serverPort": 27017} [pymongo.topology]
2026-01-08 10:30:51 [debug    ] {"message": "Connection pool created", "clientId": {"$oid": "695f875b29d04f4a8e972be7"}, "serverHost": "127.0.0.1", "serverPort": 27017} [pymongo.connection]
2026-01-08 10:30:51 [debug    ] No explicit setting existed. Use localtime [tzlocal]
2026-01-08 10:30:51 [debug    ] {"message": "Server heartbeat started", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "driverConnectionId": 1, "serverHost": "127.0.0.1", "serverPort": 27017, "awaited": false} [pymongo.topology]
collected 4 items
2026-01-08 10:30:51 [debug    ] {"message": "Server heartbeat succeeded", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "driverConnectionId": 1, "serverConnectionId": 71, "serverHost": "127.0.0.1", "serverPort": 27017, "awaited": false, "durationMS": 6.022664000738587, "reply": "{\"helloOk\": true, \"ismaster\": true, \"topologyVersion\": {\"processId\": {\"$oid\": \"695f7ebcc2cf0ed701a71632\"}}, \"maxBsonObjectSize\": 16777216, \"maxMessageSizeBytes\": 48000000, \"maxWriteBatchSize\": 100000, \"localTime\": {\"$date\": \"2026-01-08T10:30:51.212Z\"}, \"logicalSessionTimeoutMinutes\": 30, \"connectionId\": 71, \"maxWireVersion\": 25, \"ok\": 1.0}"} [pymongo.topology]
2026-01-08 10:30:51 [debug    ] {"message": "Connection pool ready", "clientId": {"$oid": "695f875b29d04f4a8e972be7"}, "serverHost": "127.0.0.1", "serverPort": 27017} [pymongo.connection]
tests/test_buttons_reverse_arg.py 2026-01-08 10:30:51 [debug    ] {"message": "Topology description changed", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "previousDescription": "<TopologyDescription id: 695f875b29d04f4a8e972be7, topology_type: Unknown, servers: [<ServerDescription ('127.0.0.1', 27017) server_type: Unknown, rtt: None>]>", "newDescription": "<TopologyDescription id: 695f875b29d04f4a8e972be7, topology_type: Single, servers: [<ServerDescription ('127.0.0.1', 27017) server_type: Standalone, rtt: 0.006022664000738587>]>"} [pymongo.topology]
2026-01-08 10:30:51 [debug    ] {"message": "Server heartbeat started", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "driverConnectionId": 1, "serverConnectionId": 71, "serverHost": "127.0.0.1", "serverPort": 27017, "awaited": true} [pymongo.topology]
2026-01-08 10:30:51 [debug    ] Loading locales additional data... [sophie_bot.services.bot]
2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
DEBUG: ButtonsArg.check input='This is a note.
[Button](btnurl:https://google.com)' res=True
DEBUG: ButtonsArg.parse input='This is a note.
[Button](btnurl:https://google.com)'
F2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
DEBUG: ButtonsArg.check input='Text
[Btn1](btnurl:https://1.com) [Btn2](btnurl:https://2.com)' res=True
DEBUG: ButtonsArg.parse input='Text
[Btn1](btnurl:https://1.com) [Btn2](btnurl:https://2.com)'
F2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
F2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
DEBUG: ButtonsArg.check input='Text
[Btn](btnurl:https://google.com)' res=True
DEBUG: ButtonsArg.parse input='Text
[Btn](btnurl:https://google.com)'
F
======================================================================================================== FAILURES =========================================================================================================
____________________________________________________________________________________________ test_reverse_arg_text_and_buttons ____________________________________________________________________________________________
    @pytest.mark.asyncio
    async def test_reverse_arg_text_and_buttons():
        # Use kwargs for ReverseArg
        arg = ReverseArg(text=TextArg(), buttons=ButtonsArg())
        # Note: URLButton requires 'btn' or 'button' prefix and valid protocol
        text = "This is a note.\n[Button](btnurl:https://google.com)"
        entities = ArgEntities([])

        assert arg.check(text, entities)

>       length, result = await arg.parse(text, 0, entities)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_buttons_reverse_arg.py:39:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.13/site-packages/ass_tg/types/reverse.py:52: in parse
    arg = await arg_fabric(post_offset_text, arg_offset, arg_entities)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/ass_tg/types/base_abc.py:117: in _call
    length, value = await self.pre_parse(text, offset, entities, **kwargs)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/ass_tg/types/base_abc.py:89: in pre_parse
    return await self.parse(text, offset, entities)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
self = <ButtonsArg>, text = 'This is a note.\n[Button](btnurl:https://google.com)', offset = 0, entities = []
    async def parse(self, text: str, offset: int, entities: ArgEntities) -> tuple[int, list[AssButtonData]]:
        print(f"DEBUG: ButtonsArg.parse input='{text}'")
        results = []
        total_length = 0
        while text.lstrip():
            stripped_text = text.lstrip()
            lstrip_len = len(text) - len(stripped_text)

            total_length += lstrip_len
            offset += lstrip_len
            text = stripped_text

            if not self.child.check(text, entities.cut_before(total_length)):
                break

            try:
                arg = await self.child(text, offset, entities.cut_before(total_length))
                results.append(arg.value)
                total_length += arg.length
                offset += arg.length
                text = text[arg.length:]
            except ArgTypeError:
                break

        if not results:
>           raise ArgTypeError(
                needed_type=self.needed_type(),
                description=self.description,
                offset=offset,
                length=len(text),
            )
E           ass_tg.exceptions.ArgTypeError
sophie_bot/modules/notes/utils/buttons_processor/ass_types/parse_arg.py:63: ArgTypeError
--------------------------------------------------------------------------------------------------- Captured log setup ----------------------------------------------------------------------------------------------------
DEBUG    pymongo.connection:logger.py:108 {"message": "Connection pool ready", "clientId": {"$oid": "695f875b29d04f4a8e972be7"}, "serverHost": "127.0.0.1", "serverPort": 27017}
DEBUG    pymongo.topology:logger.py:108 {"message": "Topology description changed", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "previousDescription": "<TopologyDescription id: 695f875b29d04f4a8e972be7, topology_type: Unknown, servers: [<ServerDescription ('127.0.0.1', 27017) server_type: Unknown, rtt: None>]>", "newDescription": "<TopologyDescription id: 695f875b29d04f4a8e972be7, topology_type: Single, servers: [<ServerDescription ('127.0.0.1', 27017) server_type: Standalone, rtt: 0.006022664000738587>]>"}
DEBUG    pymongo.topology:logger.py:108 {"message": "Server heartbeat started", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "driverConnectionId": 1, "serverConnectionId": 71, "serverHost": "127.0.0.1", "serverPort": 27017, "awaited": true}
DEBUG    sophie_bot.services.bot:i18n.py:37 {'event': 'Loading locales additional data...', 'level': 'debug', 'timestamp': '2026-01-08 10:30:51', 'logger': 'sophie_bot.services.bot'}
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
____________________________________________________________________________________________ test_reverse_arg_multiple_buttons ____________________________________________________________________________________________
    @pytest.mark.asyncio
    async def test_reverse_arg_multiple_buttons():
        arg = ReverseArg(text=TextArg(), buttons=ButtonsArg())
        # Note: URLButton requires 'btn' or 'button' prefix and valid protocol
        text = "Text\n[Btn1](btnurl:https://1.com) [Btn2](btnurl:https://2.com)"
        entities = ArgEntities([])

        assert arg.check(text, entities)
>       length, result = await arg.parse(text, 0, entities)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_buttons_reverse_arg.py:62:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.13/site-packages/ass_tg/types/reverse.py:52: in parse
    arg = await arg_fabric(post_offset_text, arg_offset, arg_entities)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/ass_tg/types/base_abc.py:117: in _call
    length, value = await self.pre_parse(text, offset, entities, **kwargs)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/ass_tg/types/base_abc.py:89: in pre_parse
    return await self.parse(text, offset, entities)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
self = <ButtonsArg>, text = 'Text\n[Btn1](btnurl:https://1.com) [Btn2](btnurl:https://2.com)', offset = 0, entities = []
    async def parse(self, text: str, offset: int, entities: ArgEntities) -> tuple[int, list[AssButtonData]]:
        print(f"DEBUG: ButtonsArg.parse input='{text}'")
        results = []
        total_length = 0
        while text.lstrip():
            stripped_text = text.lstrip()
            lstrip_len = len(text) - len(stripped_text)

            total_length += lstrip_len
            offset += lstrip_len
            text = stripped_text

            if not self.child.check(text, entities.cut_before(total_length)):
                break

            try:
                arg = await self.child(text, offset, entities.cut_before(total_length))
                results.append(arg.value)
                total_length += arg.length
                offset += arg.length
                text = text[arg.length:]
            except ArgTypeError:
                break

        if not results:
>           raise ArgTypeError(
                needed_type=self.needed_type(),
                description=self.description,
                offset=offset,
                length=len(text),
            )
E           ass_tg.exceptions.ArgTypeError
sophie_bot/modules/notes/utils/buttons_processor/ass_types/parse_arg.py:63: ArgTypeError
--------------------------------------------------------------------------------------------------- Captured log setup ----------------------------------------------------------------------------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_______________________________________________________________________________________________ test_reverse_arg_only_text ________________________________________________________________________________________________
    @pytest.mark.asyncio
    async def test_reverse_arg_only_text():
        # This should fail if ButtonsArg is mandatory (which it is)
        arg = ReverseArg(text=TextArg(), buttons=ButtonsArg())
        text = "Just text"
        entities = ArgEntities([])

        # ReverseArg checks: can I find a split where RIGHT part matches ButtonsArg?
        # ButtonsArg requires valid buttons. "Just text" has no buttons.
        # So it should return False for check.

        # However, TextArg matches everything.
        # ReverseArg iterates splits.
        # If ButtonsArg never matches, check returns False.

>       assert not arg.check(text, entities)
E       AssertionError: assert not True
E        +  where True = check('Just text', [])
E        +    where check = <ReverseArg>.check
tests/test_buttons_reverse_arg.py:87: AssertionError
--------------------------------------------------------------------------------------------------- Captured log setup ----------------------------------------------------------------------------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
_________________________________________________________________________________________ test_reverse_arg_buttons_with_newlines __________________________________________________________________________________________
    @pytest.mark.asyncio
    async def test_reverse_arg_buttons_with_newlines():
        # Buttons usually at the end, can have newlines before them?
        # ReverseArg splits string.
        arg = ReverseArg(text=TextArg(), buttons=ButtonsArg())
        text = "Text\n\n[Btn](btnurl:https://google.com)"
        entities = ArgEntities([])

        assert arg.check(text, entities)
>       length, result = await arg.parse(text, 0, entities)
                         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
tests/test_buttons_reverse_arg.py:103:
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
.venv/lib/python3.13/site-packages/ass_tg/types/reverse.py:52: in parse
    arg = await arg_fabric(post_offset_text, arg_offset, arg_entities)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/ass_tg/types/base_abc.py:117: in _call
    length, value = await self.pre_parse(text, offset, entities, **kwargs)
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
.venv/lib/python3.13/site-packages/ass_tg/types/base_abc.py:89: in pre_parse
    return await self.parse(text, offset, entities)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
_ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _ _
self = <ButtonsArg>, text = 'Text\n\n[Btn](btnurl:https://google.com)', offset = 0, entities = []
    async def parse(self, text: str, offset: int, entities: ArgEntities) -> tuple[int, list[AssButtonData]]:
        print(f"DEBUG: ButtonsArg.parse input='{text}'")
        results = []
        total_length = 0
        while text.lstrip():
            stripped_text = text.lstrip()
            lstrip_len = len(text) - len(stripped_text)

            total_length += lstrip_len
            offset += lstrip_len
            text = stripped_text

            if not self.child.check(text, entities.cut_before(total_length)):
                break

            try:
                arg = await self.child(text, offset, entities.cut_before(total_length))
                results.append(arg.value)
                total_length += arg.length
                offset += arg.length
                text = text[arg.length:]
            except ArgTypeError:
                break

        if not results:
>           raise ArgTypeError(
                needed_type=self.needed_type(),
                description=self.description,
                offset=offset,
                length=len(text),
            )
E           ass_tg.exceptions.ArgTypeError
sophie_bot/modules/notes/utils/buttons_processor/ass_types/parse_arg.py:63: ArgTypeError
--------------------------------------------------------------------------------------------------- Captured log setup ----------------------------------------------------------------------------------------------------
DEBUG    asyncio:selector_events.py:64 Using selector: EpollSelector
==================================================================================================== warnings summary =====================================================================================================
sophie_bot/config.py:142
  /home/yacha/Projects/Otty/sophie/sophie_bot/config.py:142: PydanticDeprecatedSince20: Pydantic V1 style `@validator` validators are deprecated. You should migrate to Pydantic V2 style `@field_validator` validators, see the migration guide for more details. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    @validator("operators")
sophie_bot/config.py:18
  /home/yacha/Projects/Otty/sophie/sophie_bot/config.py:18: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Config(BaseSettings):
sophie_bot/db/models/notes.py:17
  /home/yacha/Projects/Otty/sophie/sophie_bot/db/models/notes.py:17: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class NoteFile(BaseModel):
-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================================================================================= short test summary info =================================================================================================
FAILED tests/test_buttons_reverse_arg.py::test_reverse_arg_text_and_buttons - ass_tg.exceptions.ArgTypeError
FAILED tests/test_buttons_reverse_arg.py::test_reverse_arg_multiple_buttons - ass_tg.exceptions.ArgTypeError
FAILED tests/test_buttons_reverse_arg.py::test_reverse_arg_only_text - AssertionError: assert not True
FAILED tests/test_buttons_reverse_arg.py::test_reverse_arg_buttons_with_newlines - ass_tg.exceptions.ArgTypeError
============================================================================================== 4 failed, 3 warnings in 1.66s ==============================================================================================
2026-01-08 10:30:51 [debug    ] Using selector: EpollSelector  [asyncio]
2026-01-08 10:30:52 [debug    ] {"message": "Server heartbeat failed", "topologyId": {"$oid": "695f875b29d04f4a8e972be7"}, "serverHost": "127.0.0.1", "serverPort": 27017, "awaited": true, "durationMS": 1044.1111569998611, "failure": "\"_OperationCancelled('operation cancelled')\"", "driverConnectionId": 1} [pymongo.topology]