uv run python -m pytest tests/ -v --alluredir=allure_results
========================================================================================= test session starts =========================================================================================
platform linux -- Python 3.13.11, pytest-9.0.2, pluggy-1.6.0 -- /home/yacha/Projects/Otty/sophie/.venv/bin/python3
cachedir: .pytest_cache
rootdir: /home/yacha/Projects/Otty/sophie
configfile: pyproject.toml
plugins: devtools-0.12.2, asyncio-1.3.0, allure-pytest-2.15.3, anyio-4.12.1
asyncio: mode=Mode.STRICT, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collected 127 items
tests/test_buttons_arg.py::test_buttons_arg_many PASSED                                                                                                                                         [  0%]
tests/test_buttons_arg.py::test_buttons_arg_many_newlines PASSED                                                                                                                                [  1%]
tests/test_buttons_arg.py::test_buttons_arg_url PASSED                                                                                                                                          [  2%]
tests/test_buttons_arg.py::test_buttons_arg_url_same_row PASSED                                                                                                                                 [  3%]
tests/test_buttons_arg.py::test_buttons_arg_note PASSED                                                                                                                                         [  3%]
tests/test_buttons_arg.py::test_buttons_arg_rules PASSED                                                                                                                                        [  4%]
tests/test_buttons_arg.py::test_buttons_arg_rules_same PASSED                                                                                                                                   [  5%]
tests/test_buttons_arg.py::test_buttons_arg_delmsg PASSED                                                                                                                                       [  6%]
tests/test_buttons_arg.py::test_buttons_arg_delmsg_prefix PASSED                                                                                                                                [  7%]
tests/test_buttons_arg.py::test_buttons_arg_connect PASSED                                                                                                                                      [  7%]
tests/test_buttons_arg.py::test_buttons_arg_captcha PASSED                                                                                                                                      [  8%]
tests/test_buttons_arg.py::test_buttons_arg_sophie_dm PASSED                                                                                                                                    [  9%]
tests/test_buttons_arg.py::test_buttons_arg_delmsg_prefix_button PASSED                                                                                                                         [ 10%]
tests/test_buttons_arg.py::test_buttons_arg_note_same_row PASSED                                                                                                                                [ 11%]
tests/test_buttons_arg.py::test_buttons_arg_invalid_prefix PASSED                                                                                                                               [ 11%]
tests/test_buttons_arg.py::test_buttons_arg_invalid_button_type PASSED                                                                                                                          [ 12%]
tests/test_buttons_arg.py::test_buttons_arg_invalid PASSED                                                                                                                                      [ 13%]
tests/test_buttons_comparison.py::test_compare_parsers[[Google](buttonurl:https://google.com)] PASSED                                                                                           [ 14%]
tests/test_buttons_comparison.py::test_compare_parsers[[Sophie](buttonsophieurl)] PASSED                                                                                                        [ 14%]
tests/test_buttons_comparison.py::test_compare_parsers[[Rules](buttonrules)] PASSED                                                                                                             [ 15%]
tests/test_buttons_comparison.py::test_compare_parsers[[Delete](buttondelmsg)] PASSED                                                                                                           [ 16%]
tests/test_buttons_comparison.py::test_compare_parsers[[Connect](buttonconnect)] PASSED                                                                                                         [ 17%]
tests/test_buttons_comparison.py::test_compare_parsers[[WS](buttonwelcomesecurity)] PASSED                                                                                                      [ 18%]
tests/test_buttons_comparison.py::test_compare_parsers[[Note](buttonnote)] PASSED                                                                                                               [ 18%]
tests/test_buttons_comparison.py::test_compare_parsers[[NoteArg](buttonnote:arg)] PASSED                                                                                                        [ 19%]
tests/test_buttons_comparison.py::test_compare_parsers[[NoteHash](#NoteArg)] PASSED                                                                                                             [ 20%]
tests/test_buttons_comparison.py::test_compare_parsers[[Btn1](buttonurl:https://1.com) [Btn2](buttonurl:https://2.com:same)] PASSED                                                             [ 21%]
tests/test_buttons_reverse_arg.py::test_reverse_arg_text_and_buttons PASSED                                                                                                                     [ 22%]
tests/test_buttons_reverse_arg.py::test_reverse_arg_multiple_buttons PASSED                                                                                                                     [ 22%]
tests/test_buttons_reverse_arg.py::test_reverse_arg_only_text PASSED                                                                                                                            [ 23%]
tests/test_buttons_reverse_arg.py::test_reverse_arg_buttons_with_newlines PASSED                                                                                                                [ 24%]
tests/test_buttons_reverse_arg.py::test_text_with_buttons_arg_text_and_buttons PASSED                                                                                                           [ 25%]
tests/test_buttons_reverse_arg.py::test_text_with_buttons_arg_only_text_buttons_empty_list PASSED                                                                                               [ 25%]
tests/test_fillings.py::TestProcessFillings::test_combined_fillings PASSED                                                                                                                      [ 26%]
tests/test_fillings.py::TestProcessFillings::test_with_chat_fillings PASSED                                                                                                                     [ 27%]
tests/test_fillings.py::TestProcessFillings::test_with_custom_fillings PASSED                                                                                                                   [ 28%]
tests/test_fillings.py::TestProcessFillings::test_with_empty_text PASSED                                                                                                                        [ 29%]
tests/test_fillings.py::TestProcessFillings::test_with_missing_custom_key PASSED                                                                                                                [ 29%]
tests/test_fillings.py::TestProcessFillings::test_with_user_fillings PASSED                                                                                                                     [ 30%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_time_external_service_success PASSED                                                                              [ 31%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_time_external_service_exception PASSED                                                                            [ 32%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_time_external_service_disabled PASSED                                                                             [ 33%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_instrument_external_service_async PASSED                                                                          [ 33%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_instrument_external_service_sync PASSED                                                                           [ 34%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_instrument_external_service_async_exception PASSED                                                                [ 35%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_instrument_external_service_sync_exception PASSED                                                                 [ 36%]
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_specific_service_decorators PASSED                                                                                [ 37%]
tests/test_metrics/test_external.py::TestExternalServiceTracker::test_tracker_success PASSED                                                                                                    [ 37%]
tests/test_metrics/test_external.py::TestExternalServiceTracker::test_tracker_with_exception PASSED                                                                                             [ 38%]
tests/test_metrics/test_external.py::TestExternalServiceTracker::test_tracker_without_start PASSED                                                                                              [ 39%]
tests/test_metrics/test_external.py::TestExternalServiceTracker::test_tracker_disabled_metrics PASSED                                                                                           [ 40%]
tests/test_metrics/test_external.py::TestServiceIntegration::test_service_context_managers PASSED                                                                                               [ 40%]
tests/test_metrics/test_external.py::TestServiceIntegration::test_set_metrics_function PASSED                                                                                                   [ 41%]
tests/test_metrics/test_external.py::TestServiceIntegration::test_create_service_tracker_type PASSED                                                                                            [ 42%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_successful_handler_execution PASSED                                                                                          [ 43%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_handler_exception PASSED                                                                                                     [ 44%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_sampling_skip PASSED                                                                                                         [ 44%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_extract_update_info_message PASSED                                                                                           [ 45%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_extract_update_info_callback_query PASSED                                                                                    [ 46%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_get_message_kind_text PASSED                                                                                                 [ 47%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_get_message_kind_photo PASSED                                                                                                [ 48%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_get_handler_name PASSED                                                                                                      [ 48%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_webhook_transport_detection PASSED                                                                                           [ 49%]
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_concurrent_handlers PASSED                                                                                                   [ 50%]
tests/test_parse.py::test_parse_saveable_with_text_only PASSED                                                                                                                                  [ 51%]
tests/test_parse.py::test_parse_saveable_with_reply_message PASSED                                                                                                                              [ 51%]
tests/test_parse.py::test_parse_saveable_exceeding_length_limit PASSED                                                                                                                          [ 52%]
tests/test_parse.py::test_parse_saveable_with_file_data PASSED                                                                                                                                  [ 53%]
tests/test_parse.py::test_parse_reply_message_with_text PASSED                                                                                                                                  [ 54%]
tests/test_parse.py::test_parse_reply_message_with_unsupported_content_type PASSED                                                                                                              [ 55%]
tests/test_parse.py::test_extract_file_info_with_photo PASSED                                                                                                                                   [ 55%]
tests/test_parse.py::test_extract_file_info_with_non_parsable_content_type PASSED                                                                                                               [ 56%]
tests/test_parse_message_buttons.py::test_parse_message_button_url PASSED                                                                                                                       [ 57%]
tests/test_parse_message_buttons.py::test_parse_message_button_invalid PASSED                                                                                                                   [ 58%]
tests/test_parse_message_buttons.py::test_parse_message_buttons_row PASSED                                                                                                                      [ 59%]
tests/test_parse_message_buttons.py::test_parse_message_buttons_row_with_invalid PASSED                                                                                                         [ 59%]
tests/test_parse_message_buttons.py::test_parse_message_buttons PASSED                                                                                                                          [ 60%]
tests/test_parse_message_buttons.py::test_parse_message_buttons_empty PASSED                                                                                                                    [ 61%]
tests/test_random_parser_cases.py::TestRandomParser::test_avoid_triple_newlines_on_multiline_boundaries PASSED                                                                                  [ 62%]
tests/test_random_parser_cases.py::TestRandomParser::test_boundary_by_whitespace_between_sections PASSED                                                                                        [ 62%]
tests/test_random_parser_cases.py::TestRandomParser::test_empty_option_at_start_of_section PASSED                                                                                               [ 63%]
tests/test_random_parser_cases.py::TestRandomParser::test_empty_options PASSED                                                                                                                  [ 64%]
tests/test_random_parser_cases.py::TestRandomParser::test_empty_string PASSED                                                                                                                   [ 65%]
tests/test_random_parser_cases.py::TestRandomParser::test_leading_delimiter PASSED                                                                                                              [ 66%]
tests/test_random_parser_cases.py::TestRandomParser::test_multiline_options PASSED                                                                                                              [ 66%]
tests/test_random_parser_cases.py::TestRandomParser::test_multiline_with_multiple_sections PASSED                                                                                               [ 67%]
tests/test_random_parser_cases.py::TestRandomParser::test_multiple_choice_sections PASSED                                                                                                       [ 68%]
tests/test_random_parser_cases.py::TestRandomParser::test_nested_delimiters_not_supported PASSED                                                                                                [ 69%]
tests/test_random_parser_cases.py::TestRandomParser::test_no_delimiters PASSED                                                                                                                  [ 70%]
tests/test_random_parser_cases.py::TestRandomParser::test_single_choice PASSED                                                                                                                  [ 70%]
tests/test_random_parser_cases.py::TestRandomParser::test_trailing_delimiter PASSED                                                                                                             [ 71%]
tests/test_random_parser_cases.py::TestRandomParser::test_whitespace_handling PASSED                                                                                                            [ 72%]
tests/test_unparse_buttons.py::test_unparse_button_url PASSED                                                                                                                                   [ 73%]
tests/test_unparse_buttons.py::test_unparse_button_delmsg PASSED                                                                                                                                [ 74%]
tests/test_unparse_buttons.py::test_unparse_buttons PASSED                                                                                                                                      [ 74%]
tests/test_url_button.py::test_url_button_valid PASSED                                                                                                                                          [ 75%]
tests/test_url_button.py::test_url_button_http PASSED                                                                                                                                           [ 76%]
tests/test_url_button.py::test_url_button_same_row_same PASSED                                                                                                                                  [ 77%]
tests/test_url_button.py::test_url_button_same_row_hat PASSED                                                                                                                                   [ 77%]
tests/test_url_button.py::test_url_button_invalid_protocol PASSED                                                                                                                               [ 78%]
tests/test_url_button.py::test_url_button_invalid_markdown PASSED                                                                                                                               [ 79%]
tests/test_url_button.py::test_url_button_wrong_prefix PASSED                                                                                                                                   [ 80%]
tests/test_url_button.py::test_url_button_wrong_type PASSED                                                                                                                                     [ 81%]
tests/test_url_button.py::test_url_button_button_prefix PASSED                                                                                                                                  [ 81%]
tests/test_utils_api_auth.py::test_generate_token PASSED                                                                                                                                        [ 82%]
tests/test_utils_api_auth.py::test_hash_token PASSED                                                                                                                                            [ 83%]
tests/test_utils_api_auth.py::test_create_access_token PASSED                                                                                                                                   [ 84%]
tests/test_utils_api_auth.py::test_create_access_token_with_delta PASSED                                                                                                                        [ 85%]
tests/test_utils_api_auth.py::test_verify_tma_init_data_success PASSED                                                                                                                          [ 85%]
tests/test_utils_api_auth.py::test_verify_tma_init_data_invalid_hash PASSED                                                                                                                     [ 86%]
tests/test_utils_api_auth.py::test_verify_tma_init_data_missing_hash PASSED                                                                                                                     [ 87%]
tests/test_utils_api_auth.py::test_verify_tma_init_data_outdated PASSED                                                                                                                         [ 88%]
tests/test_utils_api_auth.py::test_verify_tma_init_data_future PASSED                                                                                                                           [ 88%]
tests/test_utils_api_auth.py::test_verify_telegram_login_widget_success PASSED                                                                                                                  [ 89%]
tests/test_utils_api_auth.py::test_verify_telegram_login_widget_missing_hash PASSED                                                                                                             [ 90%]
tests/test_utils_api_auth.py::test_verify_telegram_login_widget_with_none_values PASSED                                                                                                         [ 91%]
tests/test_utils_api_auth.py::test_get_current_user_success PASSED                                                                                                                              [ 92%]
tests/test_utils_api_auth.py::test_get_current_user_expired PASSED                                                                                                                              [ 92%]
tests/test_utils_api_auth.py::test_get_current_user_invalid_token PASSED                                                                                                                        [ 93%]
tests/test_utils_api_auth.py::test_get_current_user_not_found PASSED                                                                                                                            [ 94%]
tests/test_utils_api_auth.py::test_get_current_user_no_sub PASSED                                                                                                                               [ 95%]
tests/test_utils_api_auth.py::test_get_current_user_invalid_iid PASSED                                                                                                                          [ 96%]
tests/test_utils_api_auth.py::test_get_current_user_db_error PASSED                                                                                                                             [ 96%]
tests/test_utils_api_auth.py::test_get_current_operator_by_id PASSED                                                                                                                            [ 97%]
tests/test_utils_api_auth.py::test_get_current_operator_by_scope PASSED                                                                                                                         [ 98%]
tests/test_utils_api_auth.py::test_get_current_operator_forbidden PASSED                                                                                                                        [ 99%]
tests/test_utils_api_auth.py::test_get_current_operator_invalid_token PASSED                                                                                                                    [100%]
========================================================================================== warnings summary ===========================================================================================
sophie_bot/config.py:17
  /home/yacha/Projects/Otty/sophie/sophie_bot/config.py:17: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class Config(BaseSettings):
sophie_bot/db/models/notes.py:17
  /home/yacha/Projects/Otty/sophie/sophie_bot/db/models/notes.py:17: PydanticDeprecatedSince20: Support for class-based `config` is deprecated, use ConfigDict instead. Deprecated in Pydantic V2.0 to be removed in V3.0. See Pydantic V2 Migration Guide at https://errors.pydantic.dev/2.12/migration/
    class NoteFile(BaseModel):
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_time_external_service_exception
tests/test_metrics/test_external.py::TestExternalServiceInstrumentation::test_instrument_external_service_async_exception
tests/test_metrics/test_external.py::TestExternalServiceTracker::test_tracker_with_exception
tests/test_metrics/test_middleware.py::TestMetricsMiddleware::test_handler_exception
  /home/yacha/Projects/Otty/sophie/.venv/lib/python3.13/site-packages/structlog/stdlib.py:1166: UserWarning: Remove `format_exc_info` from your processor chain if you want pretty exceptions.
    ed = p(logger, meth_name, ed)  # type: ignore[arg-type]
-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=================================================================================== 127 passed, 6 warnings in 1.52s ===================================================================================
--- Logging error ---
Traceback (most recent call last):
  File "/home/yacha/Projects/Otty/sophie/.venv/lib/python3.13/site-packages/mistralai/httpclient.py", line 119, in close_clients
    loop = asyncio.get_running_loop()
RuntimeError: no running event loop
During handling of the above exception, another exception occurred:
Traceback (most recent call last):
  File "/usr/lib64/python3.13/logging/__init__.py", line 1154, in emit
    stream.write(msg + self.terminator)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
ValueError: I/O operation on closed file.
Call stack:
  File "/usr/lib64/python3.13/weakref.py", line 666, in _exitfunc
    f()
  File "/usr/lib64/python3.13/weakref.py", line 590, in __call__
    return info.func(*info.args, **(info.kwargs or {}))
  File "/home/yacha/Projects/Otty/sophie/.venv/lib/python3.13/site-packages/mistralai/httpclient.py", line 123, in close_clients
    asyncio.run(async_client.aclose())
  File "/usr/lib64/python3.13/asyncio/runners.py", line 194, in run
    with Runner(debug=debug, loop_factory=loop_factory) as runner:
  File "/usr/lib64/python3.13/asyncio/runners.py", line 58, in __enter__
    self._lazy_init()
  File "/usr/lib64/python3.13/asyncio/runners.py", line 137, in _lazy_init
    self._loop = events.new_event_loop()
  File "/usr/lib64/python3.13/asyncio/events.py", line 837, in new_event_loop
    return get_event_loop_policy().new_event_loop()
  File "/usr/lib64/python3.13/asyncio/events.py", line 734, in new_event_loop
    return self._loop_factory()
  File "/usr/lib64/python3.13/asyncio/unix_events.py", line 65, in __init__
    super().__init__(selector)
  File "/usr/lib64/python3.13/asyncio/selector_events.py", line 64, in __init__
    logger.debug('Using selector: %s', selector.__class__.__name__)
Message: 'Using selector: %s'
Arguments: ('EpollSelector',)
--- Logging error ---
pymongo.errors._OperationCancelled: operation cancelled
During handling of the above exception, another exception occurred:
Traceback (most recent call last):
  File "/usr/lib64/python3.13/logging/__init__.py", line 1154, in emit
    stream.write(msg + self.terminator)
    ~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^
ValueError: I/O operation on closed file.
Call stack:
  File "/usr/lib64/python3.13/threading.py", line 1015, in _bootstrap
    self._bootstrap_inner()
  File "/usr/lib64/python3.13/threading.py", line 1044, in _bootstrap_inner
    self.run()
  File "/usr/lib64/python3.13/threading.py", line 995, in run
    self._target(*self._args, **self._kwargs)
  File "/home/yacha/Projects/Otty/sophie/.venv/lib64/python3.13/site-packages/pymongo/periodic_executor.py", line 236, in _run
    if not self._target():
  File "/home/yacha/Projects/Otty/sophie/.venv/lib64/python3.13/site-packages/pymongo/synchronous/monitor.py", line 80, in target
    monitor._run()  # type:ignore[attr-defined]
  File "/home/yacha/Projects/Otty/sophie/.venv/lib64/python3.13/site-packages/pymongo/synchronous/monitor.py", line 214, in _run
    self._server_description = self._check_server()
  File "/home/yacha/Projects/Otty/sophie/.venv/lib64/python3.13/site-packages/pymongo/synchronous/monitor.py", line 273, in _check_server
    _debug_log(
  File "/home/yacha/Projects/Otty/sophie/.venv/lib64/python3.13/site-packages/pymongo/logger.py", line 108, in _debug_log
    logger.debug(LogMessage(**fields))
Message: <pymongo.logger.LogMessage object at 0x7f5e68989090>
Arguments: ()