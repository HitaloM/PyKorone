build_linux_onefile:
  stage: build
  image: d21d3q/python-poetry
  before_script:
    - apt update; apt install patchelf ccache -y
    - ccache -s
    - poetry install --with dev
  script:
    - poetry run make build_onefile
  artifacts:
    name: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
    paths:
      - output/
    expire_in: 1 week
  cache:
    key: "$CI_JOB_NAME"
    paths:
      - ~/.ccache


#build_windows_onefile:
#  stage: build
#  tags:
#    - windows
#  before_script:
#    - choco feature enable -n allowGlobalConfirmation
#    - choco install python
#    - choco install make
#    - (Invoke-WebRequest -Uri https://install.python-poetry.org -UseBasicParsing).Content | py -
#    - $env:Path += ";C:\Users\gitlab_runner\AppData\Roaming\Python\Scripts"
#  script:
#    - poetry install --with dev
#    - poetry run make build_onefile
#  artifacts:
#    name: "$CI_JOB_STAGE-$CI_COMMIT_REF_NAME"
#    paths:
#      - output/
#    expire_in: 1 week


build_linux_onefile_container:
  stage: build
  image: docker:latest
  needs: ["build_linux_onefile"]
  variables:
    DOCKER_IMAGE: "$CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH-binary"
  services:
    - docker:dind
  before_script:
    - ls output/
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
  script:
    - docker build --pull -t "$DOCKER_IMAGE" -f build/onefile/Dockerfile .
    - docker push "$DOCKER_IMAGE"
