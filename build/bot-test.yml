variables:
  UV_CACHE_DIR: "$CI_PROJECT_DIR/.cache/uv"
  UV_LINK_MODE: copy

# Use uv's official Python image with uv pre-installed
.test-base:
  image: ghcr.io/astral-sh/uv:0.9.26-python3.13-bookworm-slim
  cache:
    - key: uv-cache-${CI_COMMIT_REF_SLUG}
      paths:
        - .cache/uv
      policy: pull-push
    - key: venv-cache-$CI_COMMIT_REF_SLUG
      paths:
        - .venv
      policy: pull-push
    - key: libs-cache
      paths:
        - libs
      policy: pull-push
  before_script:
    # Install system dependencies only if needed
    - apt-get update && apt-get install -y --no-install-recommends make git
    # Pull libs only if not cached or outdated
    - |
      if [ ! -d "libs/stf/.git" ]; then
        mkdir -p libs
        git clone --depth 1 https://gitlab.com/SophieBot/stf.git libs/stf
      else
        cd libs/stf && git pull --ff-only && cd ../..
      fi
    - |
      if [ ! -d "libs/ass/.git" ]; then
        mkdir -p libs
        git clone --depth 1 https://gitlab.com/SophieBot/ass.git libs/ass
      else
        cd libs/ass && git pull --ff-only && cd ../..
      fi
    # Sync dependencies (uses cache, very fast if unchanged)
    - uv sync --dev --frozen

test-codestyle:
  extends: .test-base
  stage: test
  script:
    - uv run pycln . -a -c
    - uv run ruff format sophie_bot/ --check
    - uv run ruff check .

test-codeanal:
  extends: .test-base
  stage: test
  script:
    - uv run ty check

test-code:
  extends: .test-base
  stage: test
  variables:
    TOKEN: "123456:test"
  script:
    # Compile locales for tests
    - uv run pybabel compile -d locales -D sophie --use-fuzzy
    # Run tests in parallel using all available CPU cores
    - uv run pytest tests/ -v --alluredir=allure_results -x -n auto
  artifacts:
    when: always
    paths:
      - allure_results
    expire_in: 1 day
