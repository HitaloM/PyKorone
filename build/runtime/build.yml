image: quay.io/podman/stable:latest

variables:
  CONTAINERS_STORAGE: /var/lib/containers/storage

build_runtime_container:
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE"
    IMAGE_FULL: "$CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH-runtime"
  stage: build
  before_script:
    - if ! command -v make &> /dev/null || ! command -v git &> /dev/null; then
        dnf install -y make git;
      fi
    - podman login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
    - make pull_libs
  script: |
    # build
    podman manifest create "$IMAGE_FULL"
    podman build \
      --platform linux/amd64 \
      --manifest "$IMAGE_FULL" \
      --file build/runtime/Dockerfile \
      --layers \
      --build-arg BUILDKIT_INLINE_CACHE=1 \
      --build-arg BRANCH_NAME="${CI_COMMIT_BRANCH:-Local}" \
      --build-arg COMMIT_HASH="${CI_COMMIT_SHORT_SHA:-unknown}" \
      .

    podman manifest push "$IMAGE_FULL"
  cache:
    key: bot_runtime_docker_cache
    paths:
      - $CONTAINERS_STORAGE
  only:
    - beta
    - stable
    - /^dev_.*/
    - /^dev-.*/