image: quay.io/podman/stable:latest

variables:
  CONTAINERS_STORAGE: /var/lib/containers/storage

build_runtime_container:
  variables:
    IMAGE_NAME: "$CI_REGISTRY_IMAGE"
    IMAGE_FULL: "$CI_REGISTRY_IMAGE:$CI_COMMIT_BRANCH-runtime"
  stage: build
  before_script:
    - podman login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" registry.gitlab.com
  script: |
    # build
    podman build \
      --platform linux/amd64,linux/arm64 \
      --tag "$IMAGE_FULL" \
      --file build/runtime/Dockerfile \
      --layers \
      .

    # tag latest
    podman tag "$IMAGE_FULL" "$IMAGE_NAME:latest"

    # push images
    podman push "$IMAGE_FULL"
    podman push "$IMAGE_NAME:latest"
  cache:
    key: bot_runtime_docker_cache
    paths:
      - $CONTAINERS_STORAGE
  only:
    - beta
    - stable
    - /^dev_.*/
    - /^dev-.*/